<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>model.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AbstractBaseModel.html">AbstractBaseModel</a><ul class='methods'><li data-type='method'><a href="AbstractBaseModel.html#clear">clear</a></li><li data-type='method'><a href="AbstractBaseModel.html#clearErrors">clearErrors</a></li><li data-type='method'><a href="AbstractBaseModel.html#get">get</a></li><li data-type='method'><a href="AbstractBaseModel.html#getErrors">getErrors</a></li><li data-type='method'><a href="AbstractBaseModel.html#hasErrors">hasErrors</a></li><li data-type='method'><a href="AbstractBaseModel.html#inspect">inspect</a></li><li data-type='method'><a href="AbstractBaseModel.html#set">set</a></li><li data-type='method'><a href="AbstractBaseModel.html#toJSON">toJSON</a></li><li data-type='method'><a href="AbstractBaseModel.html#toObject">toObject</a></li><li data-type='method'><a href="AbstractBaseModel.html#toString">toString</a></li></ul></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="CouchbaseDocument.html">CouchbaseDocument</a><ul class='methods'><li data-type='method'><a href="CouchbaseDocument.html#.findById">findById</a></li><li data-type='method'><a href="CouchbaseDocument.html#.remove">remove</a></li><li data-type='method'><a href="CouchbaseDocument.html#getCAS">getCAS</a></li><li data-type='method'><a href="CouchbaseDocument.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="CouchbaseDocument.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="CouchbaseDocument.html#index">index</a></li><li data-type='method'><a href="CouchbaseDocument.html#remove">remove</a></li><li data-type='method'><a href="CouchbaseDocument.html#removeIndexes">removeIndexes</a></li><li data-type='method'><a href="CouchbaseDocument.html#save">save</a></li></ul></li><li><a href="Document.html">Document</a><ul class='methods'><li data-type='method'><a href="Document.html#.getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="Document.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="Document.html#getDocumentKeyValue">getDocumentKeyValue</a></li></ul></li><li><a href="Lounge.html">Lounge</a><ul class='methods'><li data-type='method'><a href="Lounge.html#connect">connect</a></li><li data-type='method'><a href="Lounge.html#disconnect">disconnect</a></li><li data-type='method'><a href="Lounge.html#getModel">getModel</a></li><li data-type='method'><a href="Lounge.html#getOption">getOption</a></li><li data-type='method'><a href="Lounge.html#model">model</a></li><li data-type='method'><a href="Lounge.html#modelNames">modelNames</a></li><li data-type='method'><a href="Lounge.html#schema">schema</a></li><li data-type='method'><a href="Lounge.html#setOption">setOption</a></li></ul></li><li><a href="MemoDriver.html">MemoDriver</a></li><li><a href="Model.html">Model</a><ul class='methods'><li data-type='method'><a href="Model.html#getCAS">getCAS</a></li><li data-type='method'><a href="Model.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="Model.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="Model.html#index">index</a></li><li data-type='method'><a href="Model.html#remove">remove</a></li><li data-type='method'><a href="Model.html#removeIndexes">removeIndexes</a></li><li data-type='method'><a href="Model.html#save">save</a></li></ul></li><li><a href="ModelInstance.html">ModelInstance</a><ul class='methods'><li data-type='method'><a href="ModelInstance.html#getCAS">getCAS</a></li><li data-type='method'><a href="ModelInstance.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="ModelInstance.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="ModelInstance.html#index">index</a></li><li data-type='method'><a href="ModelInstance.html#remove">remove</a></li><li data-type='method'><a href="ModelInstance.html#removeIndexes">removeIndexes</a></li><li data-type='method'><a href="ModelInstance.html#save">save</a></li></ul></li><li><a href="ObjectArray.html">ObjectArray</a></li><li><a href="PlainBaseModel.html">PlainBaseModel</a></li><li><a href="Schema.html">Schema</a><ul class='methods'><li data-type='method'><a href="Schema.html#add">add</a></li><li data-type='method'><a href="Schema.html#extend">extend</a></li><li data-type='method'><a href="Schema.html#get">get</a></li><li data-type='method'><a href="Schema.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="Schema.html#getRefKey">getRefKey</a></li><li data-type='method'><a href="Schema.html#hasRefPath">hasRefPath</a></li><li data-type='method'><a href="Schema.html#index">index</a></li><li data-type='method'><a href="Schema.html#method">method</a></li><li data-type='method'><a href="Schema.html#post">post</a></li><li data-type='method'><a href="Schema.html#pre">pre</a></li><li data-type='method'><a href="Schema.html#set">set</a></li><li data-type='method'><a href="Schema.html#static">static</a></li><li data-type='method'><a href="Schema.html#virtual">virtual</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">model.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { EventEmitter } from 'events';
import _ from 'lodash';
import grappling from 'grappling-hook';
import inflection from 'inflection';
import Promise from 'bluebird';

import { PlainBaseModel } from './basemodel';
import Schema from './schema';
import CouchbaseDocument from './cbdocument';
import _privateKey from './privatekey';
import { promisifyCall } from './utils';

/**
 * @name Model
 * @classdesc Model class is a base class for all &lt;code>ModelInstances&lt;/code> and it extends &lt;code>CouchbaseDocument&lt;/code>
 * @description Model class is a base class for all &lt;code>ModelInstances&lt;/code> and it extends &lt;code>CouchbaseDocument&lt;/code>
 * @class
 * @augments CouchbaseDocument
 */
export class Model extends CouchbaseDocument {}

/**
 * Compiles a schema into a Model
 * @param schema
 * @param options
 * @returns {ObjectInstance}
 * @private
 */

function compilePlainObject(schema, options) {
  class PlainModelInstance extends PlainBaseModel {
    constructor(data, options = {}) {
      super(data, options, schema);
    }
  }

  PlainModelInstance.schema = schema;

  // if the user wants to allow modifications
  if (options.freeze !== false) {
    Object.freeze(PlainModelInstance);
  }

  return PlainModelInstance;
}

/**
 * Compiles a descriptor into an &lt;code>PlainModelInstance&lt;/code> or &lt;code>ModelInstance&lt;/code>
 * @param {Schema|Object} descriptor - the schema or schema descriptor. If &lt;code>Object&lt;/code> we create a new schema and
 *                                     create an &lt;code>PlainModelInstance&lt;/code>, otherwise we create a &lt;code>ModelInstance&lt;/code>
 * @param {Object} options - Schema creation options
 * @param {String|undefined} name - the name of the model
 * @param {Driver|null} db - the database driver
 * @param {Object} config - the config
 * @returns {PlainModelInstance|ModelInstance}
 * @private
 */
export function compile(descriptor, options = {}, name = undefined, lounge) {
  // Some of the options require the reflection.
  if (typeof Proxy === 'undefined') {
    // If strict mode is off but the --harmony flag is not, fail.
    if (!options.strict) {
      throw new Error('Turning strict mode off requires --harmony flag.');
    }

    // If dot notation is on but the --harmony flag is not, fail.
    if (options.dotNotation) {
      throw new Error('Dot notation support requires --harmony flag.');
    }
  }

  let schema = descriptor;
  if (!(schema instanceof Schema)) {
    schema = new Schema(schema, options);
    return compilePlainObject(schema, options);
  }

  const db = lounge ? lounge.db : null;
  const config = lounge ? lounge.config : null;

  /**
   * ModelInstance class is the compiled class from a schema definition. It extends &lt;code>Model&lt;/code>.
   * All models generated are an instance of &lt;code>ModelInstance&lt;/code>. It also inherits &lt;code>grappling-hook&lt;/code>
   * See {@link https://www.github.com/bojand/grappling-hook grappling-hook} for pre and post hooks.
   * @class
   * @augments Model
   *
   */
  class ModelInstance extends Model {
    /**
     * This would be the constructor for the generated models.
     * @param {Object} data - the model instance data
     * @param {Object} options - optional creation options
     * @param {Boolean} options.clone - Whether to deep clone the incoming data. Default: &lt;code>false&lt;/code>.
     *                                  Make sure you wish to do this as it has performance implications. This is
     *                                  useful if you are creating multiple instances from same base data and then
     *                                  wish to modify each instance.
     * @param {Object} cas - the Couchbase &lt;code>CAS&lt;/code> value
     */
    constructor(data, options = {}, cas = undefined) {
      super(data, cas, options, schema, name);
      this[_privateKey].lounge = lounge;
      this[_privateKey].db = db || ModelInstance.db;
      this[_privateKey].config = config || ModelInstance.config;
    }
  }

  // inherit EventEmitter into the ModelInstance for ModelInstance-scoped events
  ModelInstance.emitter = new EventEmitter();
  [
    'listenerCount', 'addListener', 'emit', 'getMaxListeners', 'listenerCount', 'listeners', 'on', 'once',
    'removeAllListeners', 'removeListener', 'setMaxListeners'
  ].forEach(key => {
    ModelInstance[key] = function () {
      ModelInstance.emitter[key](...arguments);
    };
  });

  /**
   * @name schema
   * @static {Schema}
   * @memberof ModelInstance
   * @description Schema the schema of this model.
   */
  ModelInstance.schema = schema;

  /**
   * @name modelName
   * @static {String}
   * @memberof ModelInstance
   * @description The name of the model.
   */
  ModelInstance.modelName = name;

  /**
   * @name db
   * @static {Driver}
   * @memberof ModelInstance
   * @description The driver.
   */
  Object.defineProperty(ModelInstance, 'db', {
    enumerable: true,
    configurable: false,
    get: () => {
      return ModelInstance._private.db;
    }
  });

  Object.defineProperty(ModelInstance, '_private', {
    enumerable: false,
    configurable: false,
    writable: false,
    value: { db }
  });

  /**
   * @name config
   * @static {Object}
   * @memberof ModelInstance
   * @description The config.
   */
  ModelInstance.config = config;

  // Add custom methods to generated class.
  _.each(schema.methods, (method, key) => {
    if (ModelInstance.prototype[key]) {
      throw new Error(`Cannot overwrite existing ${key} method with custom method.`);
    }
    ModelInstance.prototype[key] = method;
  });

  // Add custom static methods to generated class.
  _.each(schema.statics, (method, key) => {
    if (ModelInstance[key]) {
      throw new Error(`Cannot overwrite existing ${key} static with custom method.`);
    }
    ModelInstance[key] = method;
  });

  grappling.attach(ModelInstance, {
    createThenable: function (fn) {
      return new Promise(fn);
    },
    attachToPrototype: true
  });

  setupHooks(ModelInstance, config);

  setupIndexFunctions(ModelInstance);

  setupOverrides(ModelInstance);

  // if the user wants to allow modifications
  if (options.freeze !== false) {
    Object.freeze(ModelInstance);
  }

  return ModelInstance;
}

/*!
 * Sets up hooks for the new Model
 * @param InstanceModel
 */
function setupHooks(InstanceModel, config) {
  const ourHookedFnNames = ['save', 'remove', 'index'];
  const schema = InstanceModel.schema;
  const hooks = _.values(schema.hooks);

  _.forEach(hooks, ho => {
    let addHookFn = 'addDynamicHooks';
    if (!config.promisify) {
      addHookFn = 'addFlexibleHooks';
    }
    InstanceModel.prototype[addHookFn](ho.name);
    const mwopts = { passParams: true };
    _.forEach(ho.fns, (fn, index) => {
      if (ourHookedFnNames.indexOf(ho.name) >= 0) {
        const mwFn = fn;
        if (ho.hook === 'post') {
          ho.fns[index] = function (next) {
            mwFn.apply(this);
            next();
          };
        }

        mwopts.passParams = false;
      }
    });
    InstanceModel.prototype[ho.hook](ho.name, ho.fns, mwopts);
  });
}

function generateIndexFinder(InstanceModel, path, name) {
  if (Array.isArray(path)){

    return function indexFind(...args) {
      var fn;

      if (!args || args.length &lt;= path.length) {
        fn = args.splice(-1);
        return process.nextTick(fn);
      }

      var params = args.splice(0, path.length);
      var options = args.splice(0,1)[0];

      if (args &amp;&amp; args.length > 0){
        fn = args.splice(0,1)[0];
      } else {
        fn = options;
        options = {};
      }

      if (!fn){
        fn = _.noop;
      }

      var param = params.join('_');

      const docKey = this.schema.getRefKey(name, param);
      return InstanceModel._findByIndexValue(docKey, path, options, fn);
    };

  } else {
    return function indexFind(param, options, fn) {
      if (!param) {
        return process.nextTick(fn);
      }

      const docKey = this.schema.getRefKey(name, param);
      return InstanceModel._findByIndexValue(docKey, path, options, fn);
    };
  }
}

/*!
 * Sets up index query functions
 * @param InstanceModel
 */
function setupIndexFunctions(InstanceModel) {
  if (InstanceModel &amp;&amp; InstanceModel.schema &amp;&amp; InstanceModel.schema.indexes) {
    const indexes = InstanceModel.schema.indexes;
    let v;
    for (v in indexes) {
      if (indexes.hasOwnProperty(v)) {
        const path = indexes[v].path;
        const name = indexes[v].name;
        const fnName = 'findBy'.concat(inflection.camelize(inflection.underscore(name)));
        const indexFind = generateIndexFinder(InstanceModel, path, name);
        InstanceModel[fnName] = function () {
          return promisifyCall(this, indexFind, ...arguments);
        };
      }
    }
  }
}

const overridableMethods = ['clear'];

function setupOverrides(ModelInstance) {
  const schema = ModelInstance.schema;
  _.forEach(overridableMethods, m => {
    const so = schema.get(m);
    if (_.isFunction(so)) {
      ModelInstance.prototype[m] = so;
    }
  });
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Nov 10 2016 22:30:09 GMT-0400 (AST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
