<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lounge.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AbstractBaseModel.html">AbstractBaseModel</a><ul class='methods'><li data-type='method'><a href="AbstractBaseModel.html#clear">clear</a></li><li data-type='method'><a href="AbstractBaseModel.html#clearErrors">clearErrors</a></li><li data-type='method'><a href="AbstractBaseModel.html#get">get</a></li><li data-type='method'><a href="AbstractBaseModel.html#getErrors">getErrors</a></li><li data-type='method'><a href="AbstractBaseModel.html#hasErrors">hasErrors</a></li><li data-type='method'><a href="AbstractBaseModel.html#inspect">inspect</a></li><li data-type='method'><a href="AbstractBaseModel.html#set">set</a></li><li data-type='method'><a href="AbstractBaseModel.html#toJSON">toJSON</a></li><li data-type='method'><a href="AbstractBaseModel.html#toObject">toObject</a></li><li data-type='method'><a href="AbstractBaseModel.html#toString">toString</a></li></ul></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="CouchbaseDocument.html">CouchbaseDocument</a><ul class='methods'><li data-type='method'><a href="CouchbaseDocument.html#.findById">findById</a></li><li data-type='method'><a href="CouchbaseDocument.html#.remove">remove</a></li><li data-type='method'><a href="CouchbaseDocument.html#getCAS">getCAS</a></li><li data-type='method'><a href="CouchbaseDocument.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="CouchbaseDocument.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="CouchbaseDocument.html#index">index</a></li><li data-type='method'><a href="CouchbaseDocument.html#remove">remove</a></li><li data-type='method'><a href="CouchbaseDocument.html#removeIndexes">removeIndexes</a></li><li data-type='method'><a href="CouchbaseDocument.html#save">save</a></li></ul></li><li><a href="Document.html">Document</a><ul class='methods'><li data-type='method'><a href="Document.html#.getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="Document.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="Document.html#getDocumentKeyValue">getDocumentKeyValue</a></li></ul></li><li><a href="Lounge.html">Lounge</a><ul class='methods'><li data-type='method'><a href="Lounge.html#connect">connect</a></li><li data-type='method'><a href="Lounge.html#disconnect">disconnect</a></li><li data-type='method'><a href="Lounge.html#getModel">getModel</a></li><li data-type='method'><a href="Lounge.html#getOption">getOption</a></li><li data-type='method'><a href="Lounge.html#model">model</a></li><li data-type='method'><a href="Lounge.html#modelNames">modelNames</a></li><li data-type='method'><a href="Lounge.html#schema">schema</a></li><li data-type='method'><a href="Lounge.html#setOption">setOption</a></li></ul></li><li><a href="MemoDriver.html">MemoDriver</a></li><li><a href="Model.html">Model</a><ul class='methods'><li data-type='method'><a href="Model.html#getCAS">getCAS</a></li><li data-type='method'><a href="Model.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="Model.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="Model.html#index">index</a></li><li data-type='method'><a href="Model.html#remove">remove</a></li><li data-type='method'><a href="Model.html#removeIndexes">removeIndexes</a></li><li data-type='method'><a href="Model.html#save">save</a></li></ul></li><li><a href="ModelInstance.html">ModelInstance</a><ul class='methods'><li data-type='method'><a href="ModelInstance.html#getCAS">getCAS</a></li><li data-type='method'><a href="ModelInstance.html#getDocumentKeyKey">getDocumentKeyKey</a></li><li data-type='method'><a href="ModelInstance.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="ModelInstance.html#index">index</a></li><li data-type='method'><a href="ModelInstance.html#remove">remove</a></li><li data-type='method'><a href="ModelInstance.html#removeIndexes">removeIndexes</a></li><li data-type='method'><a href="ModelInstance.html#save">save</a></li></ul></li><li><a href="ObjectArray.html">ObjectArray</a></li><li><a href="PlainBaseModel.html">PlainBaseModel</a></li><li><a href="Schema.html">Schema</a><ul class='methods'><li data-type='method'><a href="Schema.html#add">add</a></li><li data-type='method'><a href="Schema.html#extend">extend</a></li><li data-type='method'><a href="Schema.html#get">get</a></li><li data-type='method'><a href="Schema.html#getDocumentKeyValue">getDocumentKeyValue</a></li><li data-type='method'><a href="Schema.html#getRefKey">getRefKey</a></li><li data-type='method'><a href="Schema.html#hasRefPath">hasRefPath</a></li><li data-type='method'><a href="Schema.html#index">index</a></li><li data-type='method'><a href="Schema.html#method">method</a></li><li data-type='method'><a href="Schema.html#post">post</a></li><li data-type='method'><a href="Schema.html#pre">pre</a></li><li data-type='method'><a href="Schema.html#set">set</a></li><li data-type='method'><a href="Schema.html#static">static</a></li><li data-type='method'><a href="Schema.html#virtual">virtual</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lounge.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { EventEmitter } from 'events';
import _ from 'lodash';
import couchbase from 'couchbase';
import Driver from 'couchbase-driver';

import * as utils from './utils';
import Schema from './schema';
import Document from './document';
import CouchbaseDocument from './cbdocument';
import { compile, Model } from './model';

const debug = require('debug')('lounge');

const schemaConfigOptions = utils.schemaConfigOptionKeys;

export default class Lounge extends EventEmitter {
  /**
   * @classdesc The Lounge module
   * The exports object of the &lt;code>lounge&lt;/code> module is an instance of this class.
   * Most apps will only use this one instance. We copy all Couchbase &lt;code>Bucket&lt;/code> methods and properties
   * so you can call them generically from this instance as well.
   *
   * @description The Lounge constructor
   * @class
   * @augments Bucket
   * @param {Object} options
   * @param {String} options.keyPrefix - key prefix for all keys. No default. Generally useful if you wish to namespace documents. Example: &lt;code>app::env::&lt;/code>.
   * @param {String} options.keySuffix - Similar as prefix but used as a suffix
   * @param {Boolean} options.storeFullReferenceId - whether to store embedded document keys as fully expanded keys (with prefix and suffix applied)
   * or just the minimized version. default: &lt;code>false&lt;/code>
   * @param {Boolean} options.storeFullKey - Similarly to store the fully expanded document key inside the key property. default: &lt;code>false&lt;/code>
   * @param {Boolean} options.alwaysReturnArrays - set to true to force &lt;code>findyById&lt;/code> to always return an array of documents even if only a single key is passed in
   * @param {String} options.refIndexKeyPrefix - reference lookup index document key prefix. The name of the index is appended. default: &lt;code>$_ref_by_&lt;/code>
   * @param {String} options.delimiter - delimiter string used for concatenation in reference document key expansion / generation. default: &lt;code>'_'&lt;/code>. This is prepended to the reference document key.
   * @param {Boolean} options.waitForIndex - When documents are saved, indexes are updated. We can wait for this operation to finish before
   * returning from &lt;code>save()&lt;/code>. Default: &lt;code>false&lt;/code>
   * @param {Boolean} options.minimize - "minimize" schemas by removing empty objects. Default: &lt;code>true&lt;/code>
   * @param {Boolean} options.missing By default the &lt;code>findById&lt;/code> and index query functions return 3 parameters to the callback:
   *                                  &lt;code>(err, docs, missing)&lt;/code>. If this option is set to &lt;code>false&lt;/code> we won't return
   *                                  missing keys as the final param in the callback. Default: &lt;code>true&lt;/code>.
   * @param {Number} options.atomicRetryTimes - The number of attempts to make within &lt;code>Driver.atomic()&lt;/code>. Default: &lt;code>5&lt;/code>.
   *                                            See {@link https://github.com/bojand/couchbase-driver}
   * @param {Number} options.atomicRetryInterval - The time to wait between retries, in milliseconds, within &lt;code>Driver.atomic()&lt;/code>.
   *                                               Default: &lt;code>0&lt;/code>. See {@link https://github.com/bojand/couchbase-driver}
   * @param {Boolean} options.atomicLock - Whether to use &lt;code>getAndLock&lt;/code> or standard &lt;code>get&lt;/code> during atomic
   *                                       operations within indexing. Default: &lt;code>true&lt;/code>.
   *                                       See {@link https://github.com/bojand/couchbase-driver}
   * @param {Boolean} options.promisify - to enable promise support. By default all async functions support promises and return a promise.
   *                                      To disable promise support set this  option to &lt;code>false&lt;/code>, ideally at start before
   *                                      doing &lt;code>connect&lt;/code> or any other operations. Default: &lt;code>true&lt;/code>.
   *
   * @returns {Lounge}
   */
  constructor(options = {}) {
    super();
    this.models = {};
    this.bucket = null;
    this.db = null;
    this.config = _.defaults(options || {}, utils.defaultOptions);
  }

  /**
   * Connect to the database. You may define Models before connecting, but you should not create any actual document
   * instances before connecting to the database.
   * @public
   * @param {Object} options
   * @param {String} options.connectionString - connection string for the cluster
   * @param {String|Bucket} options.bucket - name of the bucket or the actual Couchbase &lt;code>bucket&lt;/code> instance
   * @param {String} options.password - password
   * @param {String} options.certpath - certpath for cluster
   * @param {Boolean} options.mock - whether to use mocking
   * @param {Function} fn callback
   * @return {Bucket} Couchbase &lt;code>Bucket&lt;/code> instance
   * @example
   * lounge.connect({
   *   connectionString: 'couchbase://127.0.0.1',
   *   bucket: 'lounge_test'
   * });
   */
  connect(options, fn) {
    return utils.promisifyCall(this, this._connect, ...arguments);
  }

  _connect(options, fn) {
    if (!options) {
      throw new Error('Need options for connect()');
    }

    if (!fn) {
      fn = _.noop;
    }

    const self = this;

    function retFn(err, bucket) {
      const b = bucket || self.bucket;
      if (b) {
        self.db = Driver.create(b, self.config);
        if (self.models) {
          for (const k in self.models) {
            if (self.models.hasOwnProperty(k)) {
              const m = self.models[k];
              m._private.db = self.db;
            }
          }
        }
      }
      return fn(err, bucket || self.bucket);
    }

    if (options.bucket &amp;&amp; typeof options.bucket === 'object') {
      this.bucket = options.bucket;

      if (this.bucket) {
        this.db = Driver.create(this.bucket, this.config);
        this.db.models = this.models;
      }

      return retFn(null, this.bucket);
    } else if (options.bucket &amp;&amp; typeof options.bucket === 'string' &amp;&amp;
      options.connectionString &amp;&amp; typeof options.connectionString === 'string') {
      debug(`connect. cluster: ${options.connectionString} bucket: ${options.bucket}`);

      const custerOpts = options.certpath ? {
        certpath: options.certpath
      } : null;
      const ClusterCtor = options.mock || process.env.LOUNGE_COUCHBASE_MOCK ? couchbase.Mock.Cluster : couchbase.Cluster;
      const args = options.password ? [options.bucket, options.password, retFn] : [options.bucket, retFn];

      const cluster = new ClusterCtor(options.connectionString, custerOpts);
      this.bucket = cluster.openBucket(...args);
    }
  }

  /**
   * Disconnect from the bucket. Deletes all defined models.
   */
  disconnect() {
    debug('disconnect');
    if (this.bucket) {
      this.bucket.disconnect();
    }

    delete this.models;
    delete this.db;

    this.models = {};
    this.db = null;
  }

  /**
   * Creates a schema. Prefer to use this over Schema constructor as this will pass along Lounge config settings.
   *
   * @public
   * @param {Object} descriptor the schema descriptor
   * @param {Object} options Schema options
   * @return {Schema} created &lt;code>Schema&lt;/code> instance
   * @example
   * var schema = lounge.schema({ name: String });
   */
  schema(descriptor, options = {}) {
    const opts = _.defaults(options, _.pick(this.config, schemaConfigOptions));
    return new Schema(descriptor, opts);
  }

  /**
   * Creates a model from a schema.
   *
   * @public
   * @param {String} name name of the model.
   * @param {Schema} schema instance
   * @param {Object} options
   * @param {Object} options.freeze - to Freeze model. See &lt;code>Object.freeze&lt;/code>. Default: &lt;code>true&lt;/code>
   * @returns {ModelInstance} The created &lt;code>ModelInstance&lt;/code> class.
   * @example
   * var Cat = lounge.model('Cat', schema);
   */
  model(name, schema, options = {}) {
    if (!(schema instanceof Schema)) {
      const opts = _.defaults(options, _.pick(this.config, schemaConfigOptions));
      schema = new Schema(schema, opts);
    }

    if (this.models[name]) {
      return this.models[name];
    }

    const M = compile(schema, options, name, this);
    this.models[name] = M;
    return M;
  }

  /**
   * Returns the model given the name.
   * @param name
   * @returns {Model|undefined} The &lt;code>ModelInstance&lt;/code> or &lt;code>undefined&lt;/code> if the model by that name does
   * not exist.
   * @example
   * var Cat = lounge.getModel('Cat');
   */
  getModel(name) {
    return this.models[name];
  }

  /**
   * Sets lounge config options
   *
   * @public
   * @param key {String} the config key
   * @param value {*} option value
   */
  setOption(key, value) {
    if (arguments.length === 1) {
      return this.config[key];
    }

    this.config[key] = value;
    return this;
  }

  /**
   * Get config option.
   * @param key {String} the config key
   * @return {*} Option value
   */
  getOption(key) {
    return this.setOption(key);
  }

  /**
   * Returns an array of model names created on this instance of Lounge.
   *
   * @public
   * @return {Array} Array of model names registered.
   * @example
   * console.log(lounge.modelNames()); // [ 'Cat', 'Dog' ]
   */
  modelNames() {
    return Object.keys(this.models);
  }

  /**
   * The Lounge Schema constructor
   *
   */
  get Schema() {
    return Schema;
  }

  /**
   * The Lounge Model constructor.
   */
  get Model() {
    return Model;
  }

  /**
   * The Lounge CouchbaseDocument constructor.
   */
  get CouchbaseDocument() {
    return CouchbaseDocument;
  }

  /**
   * The Lounge Document constructor.
   *
   */
  get Document() {
    return Document;
  }

  /**
   * The Lounge constructor
   * The exports of the Lounge module is an instance of this class.
   */
  get Lounge() {
    return Lounge;
  }
}

/**
 * Inherit all Couchbase Bucket functions and apply them to our bucket
 */
[
  'append', 'counter', 'get', 'getAndLock', 'getAndTouch', 'getMulti', 'getReplica', 'insert', 'manager', 'prepend',
  'query', 'remove', 'replace', 'set', 'setTranscoder', 'touch', 'unlock', 'upsert'

].forEach(key => {
  Lounge.prototype[key] = function () {
    if (this.db) {
      return this.db[key](...arguments);
    }
  };
});

/**
 * Inherit all Couchbase Bucket properties and apply them to our bucket
 */
[
  'configThrottle', 'connectionTimeout', 'durabilityInterval', 'durabilityTimeout', 'managementTimeout',
  'nodeConnectionTimeout', 'operationTimeout', 'viewTimeout'
].forEach(key => {
  Object.defineProperty(Lounge.prototype, key, {
    get: propertyGetWrapper(key),
    set: propertySetWrapper(key)
  });
});

function propertyGetWrapper(key) {
  return function () {
    if (this.bucket) {
      return this.bucket[key];
    }
  };
}

function propertySetWrapper(key) {
  return function (value) {
    if (this.bucket) {
      this.bucket[key] = value;
    }
  };
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Nov 10 2016 22:30:09 GMT-0400 (AST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
